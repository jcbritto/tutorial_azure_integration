name: Build and Deploy to Azure

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: jcbritto/tutorial_azure_integration
      IMAGE_TAG: ${{ github.sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run health check test
        run: |
          python - <<'PY'
          from fastapi.testclient import TestClient
          from main import app
          client = TestClient(app)
          resp = client.get("/health")
          if resp.status_code != 200 or resp.json().get("status") != "ok":
              raise SystemExit("Health check failed")
          PY

      - name: Build container image
        run: |
          docker build -t $REGISTRY/$IMAGE_NAME:${IMAGE_TAG} -t $REGISTRY/$IMAGE_NAME:latest .

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push container image
        run: |
          docker push $REGISTRY/$IMAGE_NAME:${IMAGE_TAG}
          docker push $REGISTRY/$IMAGE_NAME:latest

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Update Azure Web App container
        env:
          GHCR_DEPLOY_TOKEN: ${{ secrets.GHCR_DEPLOY_TOKEN }}
        run: |
          az webapp config container set \
            --name Tutorial \
            --resource-group Kyte-Rg \
            --container-image-name ghcr.io/jcbritto/tutorial_azure_integration:${{ github.sha }} \
            --container-registry-url https://ghcr.io \
            --container-registry-user jcbritto \
            --container-registry-password "$GHCR_DEPLOY_TOKEN"
          az webapp restart --name Tutorial --resource-group Kyte-Rg
