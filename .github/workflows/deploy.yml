name: Build and Deploy to Azure

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: jcbritto/tutorial_azure_integration
      IMAGE_TAG: ${{ github.sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run health check test
        run: |
          python - <<'PY'
          from fastapi.testclient import TestClient
          from main import app
          client = TestClient(app)
          resp = client.get("/health")
          if resp.status_code != 200 or resp.json().get("status") != "ok":
              raise SystemExit("Health check failed")
          PY

      - name: Build container image
        run: |
          docker build -t $REGISTRY/$IMAGE_NAME:${IMAGE_TAG} -t $REGISTRY/$IMAGE_NAME:latest .

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push container image
        run: |
          docker push $REGISTRY/$IMAGE_NAME:${IMAGE_TAG}
          docker push $REGISTRY/$IMAGE_NAME:latest

      - name: Restart Azure Web App
        env:
          AZURE_PUBLISH_PROFILE: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        run: |
          python - <<'PY'
          import base64
          import os
          import urllib.request
          import xml.etree.ElementTree as ET

          profile_xml = os.environ["AZURE_PUBLISH_PROFILE"]
          root = ET.fromstring(profile_xml)

          msdeploy = next(
              (p for p in root.findall("publishProfile") if p.get("publishMethod") == "MSDeploy"),
              None,
          )
          if msdeploy is None:
              raise SystemExit("MSDeploy publish profile not found")

          username = msdeploy.get("userName")
          password = msdeploy.get("userPWD")
          publish_url = msdeploy.get("publishUrl").split(":")[0]
          auth = base64.b64encode(f"{username}:{password}".encode()).decode()

          for action in ("stop", "start"):
              req = urllib.request.Request(
                  f"https://{publish_url}/api/app/{action}",
                  method="POST",
                  headers={"Authorization": f"Basic {auth}"},
              )
              with urllib.request.urlopen(req) as response:
                  if response.status >= 400:
                      raise SystemExit(f"Failed to {action} app: {response.status}")

          PY
